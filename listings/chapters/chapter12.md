# Making music on the BBC micro

## Chapter 12

### Adding harmony to a melody line
```
1 REM PROGRAM 12.1
2 REM Pseudo Harmony Additions
3 REM Insert In PROGRAM 9.1
4
300 PRINT Note$;TAB(6);Pitch;
310 SOUND1,Env,Pitch,Dur
311 PROCHarmonise
315 SOUND2,Env,Pitch-P,Dur
316 PRINTTAB(12);Pitch-P
420
430 DEF PROCHarmonise
440 HarmPoint=RND(12)
450 ON HarmPoint GOTO 460,470,470,470,470,480,480,480,490,490,500,510
460 P=8:ENDPROC
470 P=12:ENDPROC
480 P=20:ENDPROC
490 P=28:ENDPROC
500 P=32:ENDPROC
510 P=48:ENDPROC
```

```
1 REM PROGRAM 12.2
2 REM DATA Statements For
3 REM Liberty Bell
4 REM For Use in PROGRAM 12.1
5
110 FOR N=1 TO 110
180 DATA C3,3
182 DATA A2,6,A2,3,A2,3,G#2,3,A2,3
184 DATA F3,6,C3,3,C3,6,A2,3
186 DATA A#2,6,A#2,3,A#2,6,C3,3
188 DATA D3,15,A#2,3
190 DATA G2,6,G2,3,G2,3,F#2,3,G2,3
192 DATA E3,6,D3,3,D3,6,A#2,3
194 DATA A2,6,A2,3,A2,6,A#2,3
196 DATA C3,15,C3,3
198 DATA A2,6,A2,3,A2,3,G#2,3,A2,3
200 DATA A3,6,F3,3,F3,6,C3,3
202 DATA B2,6,G3,3,G3,6,G3,3
204 DATA G3,15,F3,3
206 DATA E3,6,G3,3,G3,3,F#3,3,G3,3
208 DATA D3,6,G3,3,G3,3,F#3,3,G3,3
210 DATA C3,6,B2,3,C3,6,B2,3
212 DATA C3,9,C3,9
214 REM 2nd Part
216 DATA A2,3,G#2,3,A2,3,D3,6,C3,3
218 DATA A2,9,F2,9
220 DATA D2,9,G2,9
222 DATA F2,15,F2,3
224 DATA G2,3,A2,3,A#2,3,E3,6,D3,3
226 DATA C3,9,F3,9
228 DATA E3,9,D3,9
230 DATA C3,15,C3,3
232 DATA D3,6,D3,2,E3,1,D3,3,C#3,3,D3,3
234 DATA E3,9,E3,9
236 DATA F3,6,F3,2,A3,1,G3,3,F3,3,G3,3
238 DATA A3,15,A3,2,A3,1
240 DATA G3,6,F3,3,D3,6,A#2,3
242 DATA A2,9,F2,9
244 DATA G2,9,E2,9
246 DATA F2,12
248
250
260
270
```

### The computer as a transposition aid
```
10 REM PROGRAM 12.3
20 REM Transposition Program
30
40 ON ERROR GOTO 2270
50
60 *TV255,1
70 REM Disable ESCAPE key:*FX220,1
80
90 REM Switch on CAPS LOCK
100 *FX202,32
110
120 PROCSetUp
130
140 End=FALSE
150 MODE7
160 PROCMenu
170 IF End CLS:END
180
190 MODE4
200 PROCWindows
210 PROCDisplayScales
220 GOTO150
230 END
240
250 DEF PROCSetUp
260 TClef=844:LClef=628
270 TR$=CHR$130+"TRANSPOSITION PROGRAM"
280
290 REM Treble Clef Characters
300 VDU23,229,32,32,32,160,64,0,0,0
310 VDU23,230,39,39,167,167,38,36,248,
240
320 VDU23,231,228,230,102,51,24,12,7,3
330 VDU23,232,160,32,32,32,120,164,38,
39
340 VDU23,233,1,3,12,24,48,97,227,230
350 VDU23,234,34,34,36,36,40,48,32,96
360 VDU23,235,35,35,35,35,35,35,35,35
370 VDU23,236,0,0,0,0,0,8,20,34
380 TC$=CHR$9+CHR$236+CHR$8+CHR$10+CHR$235+CHR$8+CHR$10+CHR$234+CHR$8+CHR$8+CHR$10+CHR$233+CHR$232+CHR$8+CHR$8+CHR$10+CHR$231+CHR$230+CHR$8+CHR$10+CHR$229
390
400 REM Bass Clef Characters
410 VDU23,237,31,127,192,128,128,184,120,56
420 VDU23,238,128,192,224,115,51,48,48,48
430 VDU23,239,48,51,51,48,48,32,64,128
440 VDU23,240,1,2,4,8,16,32,0,0
450 BC$=CHR$237+CHR$238+CHR$8+CHR$10+CHR$239+CHR$8+CHR$8+CHR$10+CHR$240
460
470 REM Semibrieve
480 VDU23,224,0,28,34,66,68,56,0,0
490
500 REM Crotchet
510 VDU23,225,0,28,62,126,124,56,0,0
520
530 REM Natural
540 VDU23,226,64,76,84,100,76,84,100,4
550
560 REM Flat
570 VDU23,227,64,64,92,102,70,76,120,0
580 F$=CHR$227
590
600 REM Sharp
610 VDU23,238,36,36,126,36,36,126,36,36
620 S$="#":REM S$=CHR$228
630
640 REM Offset for Lower Scale Notes
650 DIM OffSetArray%(12,12)
660 RESTORE 840
670 FOR TScale%=0 TO 12
680 FOR LScale%=0 TO 12
690 READ OffSetArray%(TScale%,LScale%)
700 NEXT LScale%
710 NEXT TScale%
720
730 DIM KeyArray$(12),MinKeyArray$(12)
740 RESTORE 980
750 FOR A=0 TO 12
760 READ K$:IF A>7 K$=K$+CHR$227
770 READ M$:IF A>10 M$=M$+CHR$227
780 KeyArray$(A)=K$
790 MinKeyArray$(A)=M$
800 NEXT A
810
820 ENDPROC
830
840 DATA 0,3,-1,2,-2,1,-3,-3,1,-2,2,-1,3
850 DATA -3,0,3,-1,2,-2,1,1,-2,2,-1,3,0
860 DATA 1,-3,0,3,-1,2,-2,-2,2,-1,3,0,-3
870 DATA -2,1,-3,0,3,-1,2,2,-1,3,0,-3,1
880 DATA 2,-2,1,-3,0,3,-1,-1,3,0,-3,1,-2
890 DATA -1,2,-2,1,-3,0,3,3,0,-3,1,-2,2
900 DATA 3,-1,2,-2,1,-3,0,0,-3,1,-2,2,-1
910 DATA 3,-1,2,-2,1,-3,0,0,-3,1,-2,2,-1
920 DATA -1,2,-2,1,-3,0,3,3,0,-3,1,-2,2
930 DATA 2,-2,1,-3,0,3,-1,-1,3,0,-3,1,-2
940 DATA -2,1,-3,0,3,-1,2,2,-1,3,0,-3,1
950 DATA 1,-3,0,3,-1,2,-2,-2,2,-1,3,0,-3
960 DATA -3,0,3,-1,2,-2,1,1,-2,2,-1,3,0
970
980 DATA C,A,G,E,D,B,A,F#,E,C#,B,G#,F#,D#,F,D,B,G,E,C,A,F,D,B,G,E
990
1000 DEF PROCMenu:CLS:PROCdd(TR$,8,0)
1010 PRINTTAB(3,3)CHR$131"Here are your options:"
1020 PRINT'CHR$129" 1.."CHR$130"Treble Clef."'CHR$129" 2.."CHR$130"Bass Clef."'CHR$129" 3.."CHR$130"End Program."
1030 PRINT'CHR$131" Please enter your choice ("CHR$129"1-3"CHR$131")?"CHR$129;
1040 PROCInput(48,52)
1050 IF Key%=49 Clf%=1:NOSet=-36
1060 IF Key%=50 Clf%=2:NOSet=-12
1070 IF Key%=51 End=TRUE:ENDPROC
1080
1090 PROCGetSF("original"):OAc%=Key%-48:Okey$=LEFT$(Ac$,1):IF Okey$="F" OAc%=OAc%+6
1100 PROCGetSF("new"):NAc%=Key%-48:Nkey$=LEFT$(Ac$,1):IF Nkey$="F" NAc%=NAc%+6
1110
1120 OffSet%=OffSetArray%(OAc%,NAc%)*12
1130
1140 PRINT'TAB(12)CHR$136CHR$131"THANKYOU":PROCD(200)
1150 ENDPROC
1160
1170 REM Double Height Letters
1180 DEF PROCdd(P$,a%,b%):FOR L%=0 TO 1:PRINTTAB(a%,b%+L%)CHR$141;P$:NEXT:ENDPROC
1190
1200 DEF PROCInput(Min%,Max%):REPEAT:Key%=GET:UNTIL Key%>Min% AND Key%<Max%:PRINTCHR$Key%:ENDPROC
1210
1220 DEF PROCGetSF(Key$)
1230 PRINT'CHR$131" Has the "Key$" key any sharps"'CHR$131" or flats ("CHR$129"S, F or N"CHR$131")?"CHR$129;
1240 REPEAT:Ans=GET:UNTIL (Ans=83 OR Ans=70 OR Ans=78):PRINTCHR$Ans:IF Ans=83 Ac$="Sharps" ELSE IF Ans=70 Ac$="Flats" ELSE Ac$="N"
1250 IF Ans=78 Key%=48:ENDPROC
1260
1270 PRINT'CHR$131"How many ";Ac$;" has it? ("CHR$129"1-6"CHR$131")?"CHR$129;:PROCInput(48,55)
1280 ENDPROC
1290
1300 DEF PROCWindows
1310 REM Set Graphics Window
1320 VDU24,0;256;1279;1023;
1330
1340 REM Background Yellow
1350 VDU19,129,131,0,0,0
1360 GCOL0,129:CLG
1370
1380 REM Foreground Black
1390 GCOL0,0
1400
1410 REM Set Text Window
1420 VDU28,030,39,24
1430 ENDPROC
1440
1450 DEF PROCDisplayScales
1460 PROCStave
1470 Hinote%=904:Lonote%=712
1480
1490 Scal=1
1500 PROCScale(Hinote%)
1510 Hinote%=Hinote%-216-OffSet%:Lonote%=Lonote%-216-OffSet%
1520
1530 Scal=2:NOSet=NOSet+48
1540 PROCScale(Lonote%-64)
1550
1560 *FX15,1
1570 PRINT''"Press ""RETURN"" to return to Menu. ";:PROCInput(12,14)
1580 ENDPROC
1590
1600 REM Draw Staves
1610 DEF PROCStave
1620 PROCS(TClef):PROCS(LClef)
1630 IF Clf%=1 PROCClef(TC$,TClef+62):PROCClef(TC$,LClef+62) ELSE PROCClef(BC$, TClef):PROCClef(BC$,LClef)
1640
1650 PROCKeySig(Okey$,OAc%,TClef+14)
1660 PROCGetKey(OAc%,TClef+160)
1670 PROCKeySig(Nkey$,NAc%,LClef+16)
1680 PROCGetKey(NAc%,LClef-256)
1690
1700 ENDPROC
1710
1720 REM Draw the Lines
1730 REM Distance between a line and
1740 REM space = 12
1750 DEF PROCS(L%):FOR Line%=L% TO L%-96 STEP-24:MOVE0,Line%:DRAW1280,Line%:NEXT:ENDPROC
1760
1770 REM Print Clef(s)
1780 DEF PROCClef(C$,Pos%):VDU5:MOVE24,Pos%:PRINTC$:VDU4:ENDPROC
1790
1800 DEF PROCD(Delay%):DL=TIME:REPEATUNTILTIME>DL+Delay%:ENDPROC
1810
1820 REM Print Notes of Scale
1830 DEF PROCScale(Pos%)
1840 X%=240
1850 Dif%=48
1860
1870 FOR Y%=Lonote% TO Hinote% STEP12:X%=X%+Dif%:PROCNote("S"):N%=((Y%+NOSet)/12)MOD7 +65:VDU5:MOVEX%,Pos%+32:PRINTCHR$ N%:VDU4:NEXT
1880 ENDPROC
1890
1900 DEF PROCNote(n$):VDU5
1910 IF n$="S" n$=CHR$224
1920 IF n$="C" n$=CHR$225
1930 MOVEX%,Y%:PRINTn$
1940
1950 IF Y%>=TClef+36 PROCLeg(TClef+36,24)
1960 IF Y%<=LClef-108 PROCLeg(LClef-108,-24)
1970 IF Scal=1:IF Y%<=TClef-108 PROCLeg(TClef-108,-24)
1980 IF Scal=2:IF Y%>=LClef-36 PROCLeg(LClef-36,24)
1990
2000 ENDPROC
2010
2020 DEF PROCLeg(H%,Step%):FOR Le%=H% TO Y% STEP Step%:MOVEX%,Le%-12:DRAWX%+28, Le%-12:NEXT:ENDPROC
2030
2040 DEF PROCKeySig(SF$,Sig%,Y%)
2050 IF SF$="S" n$=S$:Y%=Y%-2:RESTORE 2230 ELSE IF SF$="F" n$=F$:Sig%=Sig%-6:Y% =Y%-46:RESTORE 2240 ELSE ENDPROC
2060
2070 IF Clf%=2 Y%=Y%-24
2080 X%=96
2090 VDU5
2100 FOR a%=1 TO Sig%
2110 READ y%:MOVEX%,Y%+y%:PRINTn$
2120 X%=X%+24
2130 NEXT a%
2140 VDU4
2150 ENDPROC
2160
2170 DEF PROCGetKey(No,Pos)
2180 MajKey$=KeyArray$(No)
2190 MinKey$=MinKeyArray$(No)+" Minor"
2200 VDU5:MOVE32,Pos:PRINT"Key=";MajKey$;" Relative Minor=";MinKey$:VDU4
2210 ENDPROC
2220
2230 DATA 0,-36,12,-24,-60,-12 
2240 DATA 0,36,-12,24,-24,12
2250
2260 REM ERROR Routine
2270 REPORT:PRINTERR;" at line ";ERL
```
BUG??? line 690 Array
```
650 DIM OffSetArray(12,12)
```
should be
```
650 DIM OffSetArray%(12,12)
```
line 2190 array
```
2190 MinKey$=MinKeyArray(No)+" Minor"
```
should be 
```
2190 MinKey$=MinKeyArray$(No)+" Minor"
```

#### Transpose in the opposite direction 
```
1120 Offset%= OffSetArray%(OAc%,NAc%)
1125 OffSet%=(OffSet%-7*SGN(OffSet%))*12
```
